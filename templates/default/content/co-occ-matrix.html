{{define "content"}}
<script>
    document.addEventListener('DOMContentLoaded', function() {

    });
</script>
    <title>Матрица совместной встречаемости</title>
    <style>
        .heatmap-container {
            margin: 50px;
            overflow: auto;
        }

        .cell {
            stroke: #fff;
        }

        .axis text {
            font: 10px sans-serif;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .legend text {
            font: 9px sans-serif;
        }
    </style>
<div class="heatmap-container">
    <div id="heatmap"></div>
</div>

<script>
    const width = 2000;
    const height = 2000;
    const margin = {top: 80, right: 30, bottom: 100, left: 100};
    const cellSize = 20;

    const svg = d3.select("#heatmap")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    // Загрузка данных
    fetch('/api/matrix')
        .then(response => response.json())
        .then(data => {
            const {tags, matrix} = data;

            // Цветовая шкала
            const colorScale = d3.scaleSequential()
                .interpolator(d3.interpolateYlOrRd)
                .domain([0, d3.max(matrix.flat())]);

            // Создаем шкалы
            const xScale = d3.scaleBand()
                .domain(tags)
                .range([margin.left, width - margin.right])
                .padding(0.05);

            const yScale = d3.scaleBand()
                .domain(tags)
                .range([margin.top, height - margin.bottom])
                .padding(0.05);

            // Оси
            const xAxis = d3.axisTop(xScale)
                .tickSize(0)
                .tickFormat(d => d.length > 15 ? d.substring(0, 12) + "..." : d);

            const yAxis = d3.axisLeft(yScale)
                .tickSize(0)
                .tickFormat(d => d.length > 15 ? d.substring(0, 12) + "..." : d);

            // Рисуем оси
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0,${margin.top})`)
                .call(xAxis)
                .selectAll("text")
                .style("text-anchor", "start")
                .attr("transform", "rotate(45)");

            svg.append("g")
                .attr("class", "y axis")
                .attr("transform", `translate(${margin.left},0)`)
                .call(yAxis)
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("transform", "rotate(-45)");

            // Ячейки матрицы
            svg.selectAll()
                .data(tags)
                .enter()
                .selectAll()
                .data((d, i) => tags.map((t, j) => ({x: t, y: d, value: matrix[i][j]})))
                .enter()
                .append("rect")
                .attr("class", "cell")
                .attr("x", d => xScale(d.x))
                .attr("y", d => yScale(d.y))
                .attr("width", xScale.bandwidth())
                .attr("height", yScale.bandwidth())
                .attr("fill", d => colorScale(d.value))
                .append("title")
                .text(d => `${d.y} & ${d.x}\nCount: ${d.value}`);

            // Легенда
            const legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${width - 150},${margin.top})`);

            const legendScale = d3.scaleLinear()
                .domain(colorScale.domain())
                .range([0, 100]);

            const legendAxis = d3.axisRight(legendScale)
                .ticks(5)
                .tickSize(6);

            legend.append("g")
                .call(legendAxis);

            legend.selectAll("rect")
                .data(d3.range(0, 100, 2))
                .enter()
                .append("rect")
                .attr("x", 0)
                .attr("y", d => 100 - d)
                .attr("width", 10)
                .attr("height", 2)
                .attr("fill", d => colorScale(legendScale.invert(d)));
        });
</script>
{{end}}
